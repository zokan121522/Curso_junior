# Conexión a base de datos (SQLite/PostgreSQL)

# 📚 OBJETIVO DEL DÍA

## Aprender a :
	•	Crear una tabla usuarios en base de datos
	•	Insertar registros desde rutas FastAPI
	•	Leer datos guardados (GET)
	•	Usar SQLite por simplicidad (funciona igual en PostgreSQL más adelante)
&nbsp;

---

&nbsp;
## 🧠 CONCEPTOS CLAVE NUEVOS

|Concepto|	¿Qué es? |
|---------|------------|
| SQLModel | Librería basada en SQLAlchemy + Pydantic. Sirve para definir y usar modelos con Base de datos (BBDD)
| create_engine()|	Crea la conexión con la base de datos (ej. archivo .db)
| Session()	|Abre una “sesión” de trabajo con la base de datos
| session.add()	|Añade un nuevo dato (registro)
| session.commit()	|Guarda los cambios definitivamente en la base de datos
| select()|	Permite consultar (leer) datos desde la tabla
| Field(default=..., primary_key=...)|	Define campos especiales (como id auto incrementable)
| from sqlmodel import ...|	Así se importan modelos, campos y funciones de base de datos

&nbsp;

---

&nbsp;

## 📍 Pasos a seguir 

### ✅ CONTEXTO GENERAL

##### Este código crea una API real que:
	•	Guarda usuarios en una base de datos local (SQLite).
	•	Devuelve todos los usuarios que se han guardado.
	•	Usa FastAPI para la parte web y SQLModel para manejar la base de datos.

&nbsp;

---

&nbsp;
### 🔍 EXPLICACIÓN LÍNEA A LÍNEA

### 📦 1. Importamos FastAPI y SQLModel
	•	FastAPI: para crear rutas web (como /usuarios).
	•	SQLModel: para definir la estructura de la base de datos (como una tabla).
	•	Field: para definir campos de esa tabla (como nombre, edad…).
	•	create_engine: crea una conexión con la base de datos.
	•	Session: se usa para leer o guardar datos.
	•	select: sirve para pedir todos los datos guardados en la tabla

```py
from fastapi import FastAPI
from sqlmodel import SQLModel, Field, create_engine, Session, select
```

### 🚀 2. Creamos instancia FastAPI
	•	Crea tu servidor web. Igual que en clases anteriores.

```py
app = FastAPI()
```

### 🧑‍💻 3. Definimos modelo de tabla: Usuario
	•	class Usuario(...): esta clase define cómo es tu tabla.
	•	table=True: indica que esta clase será una tabla.
	•	id: campo que se genera automáticamente (clave primaria).
    •	default=None: el id lo genera SQLite automaticamente.
	•	primary_key=True:  necesitamos un campo único que identifique cada usuario (DNI digital).
	•	nombre y edad: datos que introducirá el usuario.

>💡 Es como decir: “Voy a tener una tabla usuarios con columnas: id, nombre, edad”.

```py
class Usuario(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    nombre: str
    edad: int
```


### 🛠️ 4. Creamos motor de base de datos SQLite (archivo local)

	•	sqlite:///./usuarios.db: crea un archivo .db en tu carpeta actual.
	•	engine: conexión con esa base de datos.
	•	echo=True: muestra en consola todas las operaciones SQL (para aprender está bien).


```py
sqlite_url = "sqlite:///./usuarios.db"
engine = create_engine(sqlite_url, echo=True)
```

### 🏗️ 5. Creamos las tablas si no existen
	•	SQLModel.metadata.create_all(...): crea la tabla usuarios si no existía.
	•	Se ejecuta al arrancar el programa.

```py
def crear_tablas():
    SQLModel.metadata.create_all(engine)

crear_tablas()  # Se ejecuta una vez al iniciar
```


### 📬 6. Ruta para guardar usuario (POST)
    •	Esta ruta se usa para guardar un usuario nuevo.
    •	usuario: Usuario → FastAPI espera que le mandes un JSON con nombre y edad.
    •	with as → Abre cajón, mete o lee algo, cierra cajón sin quedar abierto por error 🗄️
    •	session.add(...) → mete el usuario en una “lista temporal”.
    •	session.commit() → guarda de verdad en la base de datos.
    •	session.refresh(...) → actualiza el objeto con el ID generado.
    •	return usuario → devuelve lo que se ha guardado (ya con su ID).

```py
@app.post("/usuarios")
def crear_usuario(usuario: Usuario):
    with Session(engine) as session:
        session.add(usuario)       # Añadimos usuario a sesión
        session.commit()           # Guardamos en la base de datos
        session.refresh(usuario)   # Refresca y añade el id autogenerado
        return usuario             # Devuelve el usuario (con id incluido)
```


### 📥 7. Ruta para obtener todos los usuarios
	•	Esta ruta devuelve todos los usuarios guardados.
	•	select(Usuario) → es como hacer SELECT * FROM usuarios.
	•	session.exec(...) → ejecuta esa consulta.
	•	.all() → convierte los resultados en una lista.
	•	return usuarios → se devuelve como JSON.
```py
@app.get("/usuarios")
def obtener_usuarios():
    with Session(engine) as session:
        resultado = session.exec(select(Usuario))  # Consulta SELECT *
        usuarios = resultado.all()
        return usuarios
```

&nbsp;

---

&nbsp;
### 🧠 EN RESUMEN

|Parte del código	|¿Qué hace?|
|------|---------------------------------------------------|
|Usuario |	Define la estructura de la tabla (modelo de datos)  |
|engine |	Conecta con la base de datos .db                    |
|Session |	Permite leer y escribir en la base                  |
|/usuarios (POST) |	Guarda un nuevo usuario en la tabla     |
|/usuarios (GET) |	Devuelve todos los usuarios                 |

&nbsp;

---

&nbsp;
## 🧭 ESQUEMA VISUAL DEL CÓDIGO – BACKEND FastAPI + SQLite

```md
📦 IMPORTACIONES
────────────────────────────────────────────
| FastAPI          → rutas web (/usuarios) |
| SQLModel         → modelo tipo tabla     |
| Field            → campos de tabla       |
| create_engine    → motor base de datos   |
| Session          → abre/cierra conexión  |
| select           → SELECT * en SQL       |
────────────────────────────────────────────

⬇

🚀 INSTANCIA FastAPI
────────────────────
app = FastAPI()

⬇

🧑‍💻 DEFINICIÓN DE TABLA
──────────────────────────────────────────────
class Usuario(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    nombre: str
    edad: int
──────────────────────────────────────────────
| 🔹 Define tabla `usuarios` con columnas:   |
|    id (auto), nombre, edad                 |
| 🔹 Esquema que usará SQLite                |
──────────────────────────────────────────────

⬇

🛠️ CONFIGURACIÓN DE BASE DE DATOS
────────────────────────────────────────────────
sqlite_url = "sqlite:///./usuarios.db"
engine = create_engine(sqlite_url, echo=True)
────────────────────────────────────────────────
| 🔸 Crea archivo usuarios.db (SQLite local)   |
| 🔸 echo=True → muestra logs SQL              |
────────────────────────────────────────────────

⬇

🏗️ CREACIÓN DE TABLAS
────────────────────────────────────────────
def crear_tablas():
    SQLModel.metadata.create_all(engine)

crear_tablas()  ← Se ejecuta 1 vez al iniciar
────────────────────────────────────────────

⬇

📬 RUTA POST /usuarios
────────────────────────────────────────────────────────
@app.post("/usuarios")
def crear_usuario(usuario: Usuario):
    with Session(engine) as session:
        session.add(usuario)      ← añade en memoria
        session.commit()          ← guarda en base de datos
        session.refresh(usuario)  ← añade id autogenerado
        return usuario            ← devuelve como JSON
────────────────────────────────────────────────────────
| 🔸 Espera JSON con nombre + edad                     |
| 🔸 Devuelve el usuario creado + id generado          |
────────────────────────────────────────────────────────

⬇

📥 RUTA GET /usuarios
────────────────────────────────────────────────────────────
@app.get("/usuarios")
def obtener_usuarios():
    with Session(engine) as session:
        resultado = session.exec(select(Usuario))  ← SELECT *
        usuarios = resultado.all()                 ← .fetchAll()
        return usuarios                            ← como JSON
────────────────────────────────────────────────────────────
| 🔸 Devuelve todos los usuarios de la base de datos        |
| 🔸 Ideal para listar registros (GET = lectura)            |
────────────────────────────────────────────────────────────
```
&nbsp;

---

&nbsp;

## 🛠️ ARCHIVO: main.py (estructura base comentada)
```py
# 📦 1. Importamos FastAPI y SQLModel
from fastapi import FastAPI
from sqlmodel import SQLModel, Field, create_engine, Session, select

# 🚀 2. Creamos instancia FastAPI
app = FastAPI()

# 🧑‍💻 3. Definimos modelo de tabla: Usuario
class Usuario(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    nombre: str
    edad: int

# 🛠️ 4. Creamos motor de base de datos SQLite (archivo local)
sqlite_url = "sqlite:///./usuarios.db"
engine = create_engine(sqlite_url, echo=True)

# 🏗️ 5. Creamos las tablas si no existen
def crear_tablas():
    SQLModel.metadata.create_all(engine)

crear_tablas()  # Se ejecuta una vez al iniciar

# 📬 Ruta para guardar usuario (POST)
@app.post("/usuarios")
def crear_usuario(usuario: Usuario):
    with Session(engine) as session:
        session.add(usuario)       # Añadimos usuario a sesión
        session.commit()           # Guardamos en la base de datos
        session.refresh(usuario)   # Refrescamos para obtener el ID
        return usuario             # Se devuelve el usuario creado (con ID)

# 📥 Ruta para obtener todos los usuarios
@app.get("/usuarios")
def obtener_usuarios():
    with Session(engine) as session:
        resultado = session.exec(select(Usuario))  # Consulta SELECT *
        usuarios = resultado.all()
        return usuarios
```
&nbsp;

---

&nbsp;
## 📁 ARCHIVOS QUE DEBES TENER
```
📂 tu_proyecto/
├── main.py
└── usuarios.db   # Se genera automáticamente al correr FastAPI
```
&nbsp;

---

&nbsp;
## ✅ ¿CÓMO PROBARLO?
```bash
	1.	Ejecuta el servidor:

uvicorn main:app --reload

	2.	Abre en el navegador:

http://localhost:8000/docs

	3.	Usa el endpoint:

	•	POST /usuarios → Añadir un usuario
	•	GET /usuarios → Ver lista de usuarios
```
