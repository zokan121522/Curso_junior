# ConexiÃ³n a base de datos (SQLite/PostgreSQL)

# ğŸ“š OBJETIVO DEL DÃA

## Aprender a :
	â€¢	Crear una tabla usuarios en base de datos
	â€¢	Insertar registros desde rutas FastAPI
	â€¢	Leer datos guardados (GET)
	â€¢	Usar SQLite por simplicidad (funciona igual en PostgreSQL mÃ¡s adelante)
&nbsp;

---

&nbsp;
## ğŸ§  CONCEPTOS CLAVE NUEVOS

|Concepto|	Â¿QuÃ© es? |
|---------|------------|
| SQLModel | LibrerÃ­a basada en SQLAlchemy + Pydantic. Sirve para definir y usar modelos con Base de datos (BBDD)
| create_engine()|	Crea la conexiÃ³n con la base de datos (ej. archivo .db)
| Session()	|Abre una â€œsesiÃ³nâ€ de trabajo con la base de datos
| session.add()	|AÃ±ade un nuevo dato (registro)
| session.commit()	|Guarda los cambios definitivamente en la base de datos
| select()|	Permite consultar (leer) datos desde la tabla
| Field(default=..., primary_key=...)|	Define campos especiales (como id auto incrementable)
| from sqlmodel import ...|	AsÃ­ se importan modelos, campos y funciones de base de datos

&nbsp;

---

&nbsp;

## ğŸ“ Pasos a seguir 

### âœ… CONTEXTO GENERAL

##### Este cÃ³digo crea una API real que:
	â€¢	Guarda usuarios en una base de datos local (SQLite).
	â€¢	Devuelve todos los usuarios que se han guardado.
	â€¢	Usa FastAPI para la parte web y SQLModel para manejar la base de datos.

&nbsp;

---

&nbsp;
### ğŸ” EXPLICACIÃ“N LÃNEA A LÃNEA

### ğŸ“¦ 1. Importamos FastAPI y SQLModel
	â€¢	FastAPI: para crear rutas web (como /usuarios).
	â€¢	SQLModel: para definir la estructura de la base de datos (como una tabla).
	â€¢	Field: para definir campos de esa tabla (como nombre, edadâ€¦).
	â€¢	create_engine: crea una conexiÃ³n con la base de datos.
	â€¢	Session: se usa para leer o guardar datos.
	â€¢	select: sirve para pedir todos los datos guardados en la tabla

```py
from fastapi import FastAPI
from sqlmodel import SQLModel, Field, create_engine, Session, select
```

### ğŸš€ 2. Creamos instancia FastAPI
	â€¢	Crea tu servidor web. Igual que en clases anteriores.

```py
app = FastAPI()
```

### ğŸ§‘â€ğŸ’» 3. Definimos modelo de tabla: Usuario
	â€¢	class Usuario(...): esta clase define cÃ³mo es tu tabla.
	â€¢	table=True: indica que esta clase serÃ¡ una tabla.
	â€¢	id: campo que se genera automÃ¡ticamente (clave primaria).
    â€¢	default=None: el id lo genera SQLite automaticamente.
	â€¢	primary_key=True:  necesitamos un campo Ãºnico que identifique cada usuario (DNI digital).
	â€¢	nombre y edad: datos que introducirÃ¡ el usuario.

>ğŸ’¡ Es como decir: â€œVoy a tener una tabla usuarios con columnas: id, nombre, edadâ€.

```py
class Usuario(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    nombre: str
    edad: int
```


### ğŸ› ï¸ 4. Creamos motor de base de datos SQLite (archivo local)

	â€¢	sqlite:///./usuarios.db: crea un archivo .db en tu carpeta actual.
	â€¢	engine: conexiÃ³n con esa base de datos.
	â€¢	echo=True: muestra en consola todas las operaciones SQL (para aprender estÃ¡ bien).


```py
sqlite_url = "sqlite:///./usuarios.db"
engine = create_engine(sqlite_url, echo=True)
```

### ğŸ—ï¸ 5. Creamos las tablas si no existen
	â€¢	SQLModel.metadata.create_all(...): crea la tabla usuarios si no existÃ­a.
	â€¢	Se ejecuta al arrancar el programa.

```py
def crear_tablas():
    SQLModel.metadata.create_all(engine)

crear_tablas()  # Se ejecuta una vez al iniciar
```


### ğŸ“¬ 6. Ruta para guardar usuario (POST)
    â€¢	Esta ruta se usa para guardar un usuario nuevo.
    â€¢	usuario: Usuario â†’ FastAPI espera que le mandes un JSON con nombre y edad.
    â€¢	with as â†’ Abre cajÃ³n, mete o lee algo, cierra cajÃ³n sin quedar abierto por error ğŸ—„ï¸
    â€¢	session.add(...) â†’ mete el usuario en una â€œlista temporalâ€.
    â€¢	session.commit() â†’ guarda de verdad en la base de datos.
    â€¢	session.refresh(...) â†’ actualiza el objeto con el ID generado.
    â€¢	return usuario â†’ devuelve lo que se ha guardado (ya con su ID).

```py
@app.post("/usuarios")
def crear_usuario(usuario: Usuario):
    with Session(engine) as session:
        session.add(usuario)       # AÃ±adimos usuario a sesiÃ³n
        session.commit()           # Guardamos en la base de datos
        session.refresh(usuario)   # Refresca y aÃ±ade el id autogenerado
        return usuario             # Devuelve el usuario (con id incluido)
```


### ğŸ“¥ 7. Ruta para obtener todos los usuarios
	â€¢	Esta ruta devuelve todos los usuarios guardados.
	â€¢	select(Usuario) â†’ es como hacer SELECT * FROM usuarios.
	â€¢	session.exec(...) â†’ ejecuta esa consulta.
	â€¢	.all() â†’ convierte los resultados en una lista.
	â€¢	return usuarios â†’ se devuelve como JSON.
```py
@app.get("/usuarios")
def obtener_usuarios():
    with Session(engine) as session:
        resultado = session.exec(select(Usuario))  # Consulta SELECT *
        usuarios = resultado.all()
        return usuarios
```

&nbsp;

---

&nbsp;
### ğŸ§  EN RESUMEN

|Parte del cÃ³digo	|Â¿QuÃ© hace?|
|------|---------------------------------------------------|
|Usuario |	Define la estructura de la tabla (modelo de datos)  |
|engine |	Conecta con la base de datos .db                    |
|Session |	Permite leer y escribir en la base                  |
|/usuarios (POST) |	Guarda un nuevo usuario en la tabla     |
|/usuarios (GET) |	Devuelve todos los usuarios                 |

&nbsp;

---

&nbsp;
## ğŸ§­ ESQUEMA VISUAL DEL CÃ“DIGO â€“ BACKEND FastAPI + SQLite

```md
ğŸ“¦ IMPORTACIONES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
| FastAPI          â†’ rutas web (/usuarios) |
| SQLModel         â†’ modelo tipo tabla     |
| Field            â†’ campos de tabla       |
| create_engine    â†’ motor base de datos   |
| Session          â†’ abre/cierra conexiÃ³n  |
| select           â†’ SELECT * en SQL       |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â¬‡

ğŸš€ INSTANCIA FastAPI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = FastAPI()

â¬‡

ğŸ§‘â€ğŸ’» DEFINICIÃ“N DE TABLA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Usuario(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    nombre: str
    edad: int
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
| ğŸ”¹ Define tabla `usuarios` con columnas:   |
|    id (auto), nombre, edad                 |
| ğŸ”¹ Esquema que usarÃ¡ SQLite                |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â¬‡

ğŸ› ï¸ CONFIGURACIÃ“N DE BASE DE DATOS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sqlite_url = "sqlite:///./usuarios.db"
engine = create_engine(sqlite_url, echo=True)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
| ğŸ”¸ Crea archivo usuarios.db (SQLite local)   |
| ğŸ”¸ echo=True â†’ muestra logs SQL              |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â¬‡

ğŸ—ï¸ CREACIÃ“N DE TABLAS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def crear_tablas():
    SQLModel.metadata.create_all(engine)

crear_tablas()  â† Se ejecuta 1 vez al iniciar
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â¬‡

ğŸ“¬ RUTA POST /usuarios
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.post("/usuarios")
def crear_usuario(usuario: Usuario):
    with Session(engine) as session:
        session.add(usuario)      â† aÃ±ade en memoria
        session.commit()          â† guarda en base de datos
        session.refresh(usuario)  â† aÃ±ade id autogenerado
        return usuario            â† devuelve como JSON
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
| ğŸ”¸ Espera JSON con nombre + edad                     |
| ğŸ”¸ Devuelve el usuario creado + id generado          |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â¬‡

ğŸ“¥ RUTA GET /usuarios
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.get("/usuarios")
def obtener_usuarios():
    with Session(engine) as session:
        resultado = session.exec(select(Usuario))  â† SELECT *
        usuarios = resultado.all()                 â† .fetchAll()
        return usuarios                            â† como JSON
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
| ğŸ”¸ Devuelve todos los usuarios de la base de datos        |
| ğŸ”¸ Ideal para listar registros (GET = lectura)            |
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```
&nbsp;

---

&nbsp;

## ğŸ› ï¸ ARCHIVO: main.py (estructura base comentada)
```py
# ğŸ“¦ 1. Importamos FastAPI y SQLModel
from fastapi import FastAPI
from sqlmodel import SQLModel, Field, create_engine, Session, select

# ğŸš€ 2. Creamos instancia FastAPI
app = FastAPI()

# ğŸ§‘â€ğŸ’» 3. Definimos modelo de tabla: Usuario
class Usuario(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    nombre: str
    edad: int

# ğŸ› ï¸ 4. Creamos motor de base de datos SQLite (archivo local)
sqlite_url = "sqlite:///./usuarios.db"
engine = create_engine(sqlite_url, echo=True)

# ğŸ—ï¸ 5. Creamos las tablas si no existen
def crear_tablas():
    SQLModel.metadata.create_all(engine)

crear_tablas()  # Se ejecuta una vez al iniciar

# ğŸ“¬ Ruta para guardar usuario (POST)
@app.post("/usuarios")
def crear_usuario(usuario: Usuario):
    with Session(engine) as session:
        session.add(usuario)       # AÃ±adimos usuario a sesiÃ³n
        session.commit()           # Guardamos en la base de datos
        session.refresh(usuario)   # Refrescamos para obtener el ID
        return usuario             # Se devuelve el usuario creado (con ID)

# ğŸ“¥ Ruta para obtener todos los usuarios
@app.get("/usuarios")
def obtener_usuarios():
    with Session(engine) as session:
        resultado = session.exec(select(Usuario))  # Consulta SELECT *
        usuarios = resultado.all()
        return usuarios
```
&nbsp;

---

&nbsp;
## ğŸ“ ARCHIVOS QUE DEBES TENER
```
ğŸ“‚ tu_proyecto/
â”œâ”€â”€ main.py
â””â”€â”€ usuarios.db   # Se genera automÃ¡ticamente al correr FastAPI
```
&nbsp;

---

&nbsp;
## âœ… Â¿CÃ“MO PROBARLO?
```bash
	1.	Ejecuta el servidor:

uvicorn main:app --reload

	2.	Abre en el navegador:

http://localhost:8000/docs

	3.	Usa el endpoint:

	â€¢	POST /usuarios â†’ AÃ±adir un usuario
	â€¢	GET /usuarios â†’ Ver lista de usuarios
```
