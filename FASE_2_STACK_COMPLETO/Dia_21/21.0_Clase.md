# Clase 21 – Rutas dinámicas, parámetros y validación en FastAPI
---
#### Hoy aprenderás a capturar datos directamente desde la URL, validar que existan y devolver respuestas personalizadas.



## 📚 OBJETIVO DEL DÍA
```bash
Crear una pequeña API con una ruta dinámica:
	•	GET /usuario/{id}
	•	Buscará el ID en una lista simulada y devolverá su información
	•	Si no existe, devuelve un error 404 con mensaje claro
```
---

## 💡 Pista extra para reconstruir tu main.py
```py
1.	Comienza siempre con las importaciones (FastAPI, HTTPException, JSONResponse).
2.	Crea la instancia de app con app = FastAPI().
3.	Define tu lista usuarios con al menos 3 diccionarios.
4.	Usa @app.get("/usuario/{id}") para crear una ruta dinámica.
5.	Dentro de la función, recorre la lista y busca el id.
6.	Devuelve una respuesta JSON si existe, o lanza un error si no.
```
## 🧪 EJERCICIO_ 1 
```py
# Búsqueda en lista con GET /usuario/{id} y respuesta condicional
# 📄 main.py
# 📦 1. Importamos FastAPI + herramientas extra
from fastapi import FastAPI, HTTPException
from fastapi.responses import JSONResponse

# 🚀 2. Creamos la instancia de FastAPI
app = FastAPI()

# 🧑‍🤝‍🧑 3. Simulamos una lista de usuarios
usuarios = [
    {"id": 1, "nombre": "Ana", "edad": 28},
    {"id": 2, "nombre": "Luis", "edad": 35},
    {"id": 3, "nombre": "Clara", "edad": 22},
]

# 📍 4. Ruta dinámica con parámetro: /usuario/2
@app.get("/usuario/{id}")
def obtener_usuario(id: int):  # 👈 FastAPI convierte id a número automáticamente
    for usuario in usuarios:
        if usuario["id"] == id:
            # 🎁 Si se encuentra, devolvemos un JSON con los datos
            return JSONResponse(content=usuario, status_code=200)
    
    # ❌ Si no se encuentra, lanzamos un error 404
    raise HTTPException(status_code=404, detail=f"Usuario con id {id} no encontrado")
```

## 🧭 FLUJO LÓGICO

|Paso	|¿Qué ocurre?|
|-------|-------------------------------------------------------|
| 1.	| Se entra a la ruta /usuario/2 desde el navegador o Postman|
| 2.	| FastAPI detecta el 2 como parámetro y lo guarda en id |
| 3.	| Se recorre la lista usuarios buscando coincidencia |
| 4.	| Si encuentra un usuario con id == 2, lo devuelve como JSON |
| 5.	| Si no lo encuentra, lanza un error 404 automáticamente |

---
## 🧪 EJERCICIO_ 2 
```py
# Ruta dinámica GET /usuario/{id} con validación y respuesta personalizada
# 📄 main.py
# ✅ Importamos FastAPI y las herramientas para respuestas y errores personalizados
from fastapi import FastAPI, HTTPException        # 🧠 FastAPI + gestión de errores
from fastapi.responses import JSONResponse        # 🧾 Para personalizar la respuesta en formato JSON

# 🧠 Creamos instancia de la app FastAPI
app = FastAPI()

# 📦 Simulamos una "base de datos" con usuarios ficticios
usuarios = {
    1: {"nombre": "Ana García", "edad": 28},
    2: {"nombre": "Luis Pérez", "edad": 35},
    3: {"nombre": "Carlos Ruiz", "edad": 40}
}

# 📡 Ruta dinámica: GET /usuario/1 → captura el número como parámetro
@app.get("/usuario/{id}")  # 🔁 Lo que va entre {id} se extrae desde la URL
def obtener_usuario(id: int):  # 🔢 Tipamos el parámetro como entero → FastAPI lo convierte automáticamente

    # 🧪 Comprobamos si el usuario existe en el diccionario
    if id not in usuarios:
        # 🚨 Si no existe, lanzamos error con código 404 y mensaje
        raise HTTPException(
            status_code=404,                     # 📛 Código de error HTTP: 404 = No encontrado
            detail=f"Usuario con id {id} no encontrado"  # 📝 Mensaje de error visible
        )

    # ✅ Si existe, devolvemos una respuesta JSON personalizada
    return JSONResponse(
        content={                                 # 🔁 Diccionario que se convierte en JSON
            "usuario": usuarios[id],
            "mensaje": f"Hola, {usuarios[id]['nombre']} 👋"
        },
        status_code=200                           # ✅ Código 200 = OK
    )
```
## 🧭 FLUJO LÓGICO
| Paso | Acción                                                                 | Explicación                                                                 |
|------|------------------------------------------------------------------------|-----------------------------------------------------------------------------|
| 1.  | Importar FastAPI, HTTPException y JSONResponse                        | Se preparan las herramientas necesarias para gestionar rutas y respuestas  |
| 2.  | Crear instancia `app = FastAPI()`                                      | Se inicia el servidor web de FastAPI                                       |
| 3.  | Definir un diccionario `usuarios` simulando una base de datos         | Clave = ID del usuario, Valor = datos del usuario                          |
| 4.  | Crear ruta dinámica `@app.get("/usuario/{id}")`                       | Ruta que captura el parámetro dinámico `id` desde la URL                   |
| 5.  | Definir la función `obtener_usuario(id: int)`                         | Se convierte automáticamente el `id` de string a número (int)             |
| 6.  | Comprobar si `id` existe en `usuarios`                                | Validación básica para evitar errores si el ID no existe                   |
| 7.  | Si el `id` no existe, lanzar `HTTPException` con status 404           | Devuelve un error controlado: “Usuario no encontrado”                      |
| 8.  | Si el `id` existe, usar `JSONResponse` para devolver los datos        | Se responde con un JSON que incluye el usuario y un mensaje personalizado |
| 9.  | Se devuelve status 200 (OK)                                           | Todo ha funcionado correctamente                                           |

---

## 🧠 APRENDIZAJE CLAVE
```bash
•	Puedes recibir datos directamente desde la URL (/usuario/{id})
•	FastAPI los convierte al tipo que hayas definido (int, str, etc.)
•	Si algo va mal, puedes lanzar errores limpios con HTTPException
•	Puedes devolver objetos JSON personalizados con JSONResponse
```
---
## 📝  TABLA CONCEPTOS CLAVE 
| Elemento                                | ¿Qué hace?                                                                                      |
|-----------------------------------------|--------------------------------------------------------------------------------------------------|
| `@app.get("/usuario/{id}")`             | Crea una ruta dinámica. Lo que esté entre llaves `{id}` se captura desde la URL (ej: `/usuario/2`). |
| `def obtener_usuario(id: int)`          | Define la función que se ejecuta al acceder a la ruta. El `id` se convierte a número automáticamente. |
| `Response`                              | Representa la respuesta HTTP personalizada (contenido, tipo, estado, etc.).                      |
| `JSON`                                  | Formato de intercambio de datos entre backend y frontend. Ejemplo: `{ "nombre": "Ana" }`.        |
| `dict`                                  | Tipo de dato en Python (diccionario) que FastAPI convierte en JSON automáticamente.              |
| `status_code`                           | Código que indica el estado de la respuesta (ej: 200 = OK, 404 = No encontrado, etc.).           |
| `raise HTTPException(...)`              | Lanza un error controlado con código y mensaje personalizado si algo falla.                     |
| `from fastapi.responses import JSONResponse` | Permite enviar una respuesta personalizada como JSON.                                       |
| `from fastapi import HTTPException`     | Permite importar la clase para lanzar errores HTTP personalizados.                              |
| `@app.get(...)`                         | Decorador que define una ruta de tipo GET (lectura de información).                             |
| `f"texto {variable}"`                   | f-string: inserta variables en texto fácilmente. Ej: `f"Hola {nombre}"`.                         |
| `return {...}`                          | En FastAPI, si devuelves un diccionario, se convierte en JSON automáticamente.                  |
| `type(parametro) == int`                | Verifica si una variable es del tipo `int` (aunque FastAPI ya lo controla si lo has tipado).    |
---

## 🧾 Tabla de Códigos de Estado HTTP – Respuestas comunes en APIs FastAPI
| Código | Significado        | Cuándo se usa                                                |
|--------|--------------------|--------------------------------------------------------------|
| 200    | ✅ OK              | Todo ha ido bien (GET, POST exitoso, etc.)                  |
| 201    | ✅ Created         | Recurso creado correctamente (POST que crea algo)           |
| 400    | ❌ Bad Request     | El cliente envió algo mal (faltan datos, mal formato, etc.) |
| 401    | 🔒 Unauthorized    | No estás autenticado                                         |
| 403    | ⛔ Forbidden       | No tienes permisos para acceder                             |
| 404    | 🔍 Not Found       | No se encontró lo que pediste (como en este ejemplo de ID)  |
| 500    | 💥 Server Error    | Algo se rompió en el servidor                               |
---

## 🧪 PRUEBA RÁPIDA
```bash
Haz esto en el navegador o Postman:
	•	http://localhost:8000/usuario/1 → ✅ Devuelve Ana
	•	http://localhost:8000/usuario/99 → ❌ Error 404: Usuario no encontrado
```
---
## 🧾 OPCIONAL – Auto documentación
```bash
	•	🌐 Accede a: http://localhost:8000/docs
	•	Puedes probar todo desde ahí sin Postman
```
